"use strict";ang.controller("AppCtrl",["$scope","$ionicModal","$timeout","$ionicActionSheet","$rootScope","Users","Plugins","$ionicPopup","$ionicLoading","Config","$ionicScrollDelegate","$http","CrudPlugin","$ionicSideMenuDelegate","$ionicHistory","DiceRoll",function(e,t,a,n,o,i,s,r,c,u,l,d,g,m,f,v){function p(t){e.config&&e.config.vibrate&&navigator.vibrate(t)}function h(t){try{c.show({template:"Carregando Personagens..."}),i.returnUsers().then(function(a){e.users=a,e.$digest(),c.hide(),""==e.user.id&&(t&&m.toggleLeft(),p(100))},function(t){c.hide(),console.log(t),e.users=[],m.toggleLeft()})}catch(e){I(e)}}function b(t){var a=new Promise(function(t,a){g.Crud.ExecuteQueryConsulta({query:"select * from tbpericias",args:[]}).then(function(a){e.listapericias=a.sort(function(e,t){return e.nome<t.nome?-1:e.nome>t.nome?1:0}),t()},function(e){console.log(e),a()})});return a}function w(){var t=new Promise(function(t,a){g.Crud.ExecuteQueryConsulta({query:"select * from tbvantagens",args:[]}).then(function(a){e.listavantagens=a.sort(function(e,t){return e.nome<t.nome?-1:e.nome>t.nome?1:0}),t(!0)}).catch(function(e){a(e)})});return t}function y(){var t=new Promise(function(t,a){g.Crud.ExecuteQueryConsulta({query:"select * from tbdesvantagens",args:[]}).then(function(a){e.listadesvantagens=a.sort(function(e,t){return e.nome<t.nome?-1:e.nome>t.nome?1:0}),t(!0)}).catch(function(e){a(e)})});return t}s.Sql.InitCharge(),e.pericianova={tipo:"",nome:"",nh:"",custo:""},e.somacustopericias=0,e.labelVantagemTotal=0,e.labelDesVantagemTotal=0,e.atributoscustonovaficha=0,e.totalprecoficha=0,h(!0),e.user=i.getUser(),e.vantagem={},e.desvantagem={},e.pericia={},u.Config().then(function(t){e.config=t,console.log(t)},function(e){console.log(e)});var I=function(e){r.alert({title:"Informação",template:e})},C=u.windowConfig;e.windowConfig=C,e.listapericias=[],e.listavantagens=[],e.listadesvantagens=[];var q=function(){var t=document.getElementById("myCanvas");if(t){t=t.getContext("2d");var a=document.createElement("img");a.src="";var n=C.screenResolution.getIdealw(),o=C.screenResolution.getIdealh();t.clearRect(0,0,n,o)}if(t=document.getElementById("myCanvas2").getContext("2d")){var n=u.windowConfig.screenResolution.getIdealw(),o=u.windowConfig.screenResolution.getIdealh();t.clearRect(0,0,n,o)}e.pericia.nome="",e.desvantagem.nome="",e.vantagem.nome="",e.user=i.getUser(),p(100)};t.fromTemplateUrl("templates/sobre.html",{scope:e}).then(function(t){e.modal=t}),t.fromTemplateUrl("templates/novo.html",{scope:e}).then(function(t){e.user=i.getUser(),e.novo=t,e.imgurl=""}),t.fromTemplateUrl("templates/cadpericias.html",{scope:e}).then(function(t){e.cadastros=t}),t.fromTemplateUrl("templates/cadvantagem.html",{scope:e}).then(function(t){e.cadvantagem=t}),t.fromTemplateUrl("templates/caddesvantagem.html",{scope:e}).then(function(t){e.caddesvantagem=t}),t.fromTemplateUrl("templates/config.html",{scope:e}).then(function(t){e.configuracoes=t}),t.fromTemplateUrl("templates/Dice.html",{scope:e}).then(function(t){e.dice=t}),e.closeLogin=function(){e.modal.hide()},e.closeModal=function(t){var a=document.getElementById("myCanvas");if(a){a=a.getContext("2d");var n=C.screenResolution.getIdealw(),o=C.screenResolution.getIdealh();a.clearRect(0,0,n,o)}e.listapericias=[],e.listavantagens=[],e.listadesvantagens=[],"novo"==t?(e.totalprecoficha=0,e.user=i.getUser(),e.novo.hide(),p(100)):"sobre"==t?(e.user=i.getUser(),e.modal.hide(),p(100)):"configuracoes"==t?(e.configuracoes.hide(),p(100)):"cadastros"==t?(e.cadastros.hide(),p(100)):"vantagens"==t?(e.cadvantagem.hide(),p(100)):"desvantagens"==t?(e.caddesvantagem.hide(),p(100)):"equipamentos"==t?(e.equipamentos.hide(),p(100)):"tools"==t&&(e.dice.hide(),p(100))},e.action=function(){n.show({buttons:[{text:'<span class="ion-person-add positive biggo"></span>  <span class="positive">Novo Personagem</span> '},{text:'<span class="ion-settings positive biggo"></span> <span class="positive">Ferramentas</span>'},{text:'<span class="ion-gear-b positive biggo"></span> <span class="positive">Configurações</span> '},{text:'<span class="ion-plus-circled positive biggo"></span> <span class="positive">Pericias</span> '},{text:'<span class="ion-plus-circled positive biggo"></span> <span class="positive">Vantagens</span> '},{text:'<span class="ion-plus-circled positive biggo"></span> <span class="positive">Desvantages</span> '},{text:'<span class="ion-information-circled positive biggo"></span> <span class="positive">Sobre</span>'}],titleText:'<span style="text-align:center" class="ion-ios-settings-strong assertive biggo"> Opções</span>',buttonClicked:function(t){if(l.scrollTop(),0==t){if(q(),e.config.firstRun){r.alert({title:"First Run",template:"Atenção, não esqueça de personalizar vantagens/desvantagens que  contém itens que podem variar o custo de acordo com nt/narrador critérios!"});return e.config.firstRun=!1,void e.updateConfig(e.config)}c.show({template:"Atualizando tabelas..."}),e.novo.show().then(function(){e.limpar(),c.hide(),e.editando=!1})}return 1==t&&e.dice.show(),2==t&&(u.Config().then(function(t){e.config=t,e.lblCamQuality=u.Util.getLabelQualityFoto(e.config.quality)},function(e){console.log(e)}),e.configuracoes.show()),3==t&&(c.show({template:"Atualizando tabelas..."}),e.cadastros.show().then(function(){b(!1).then(function(t){c.hide(),e.listavantagens=[],e.listadesvantagens=[],e.pericianova.nome=""},function(){e.cadastros.show()})})),4==t&&(c.show({template:"Atualizando tabelas..."}),e.cadvantagem.show().then(function(){w().then(function(){e.listadesvantagens=[],e.listapericias=[],c.hide()}).catch(function(){c.hide(),console.log("fuuuu")})})),5==t&&(c.show({template:"Atualizando tabelas..."}),e.caddesvantagem.show().then(function(){y().then(function(){c.hide()}).catch(function(e){c.hide(),console.log("fuuuu: "+e)})})),6==t&&e.modal.show(),!0}})},e.eventoclick=function(e){o.$emit("someEvent",e)};var R=function(e){for(var t=0,a=e.length-1;a>=0;a--)t+=parseInt(e[a].custo);return t};e.addVantagem=function(t){e.user.vantagens=e.user.vantagens||[];var a=e.user.vantagens.search({key:"nome",value:t.nome});a||(e.user.vantagens.unshift({nome:t.nome,custo:t.custo,plus:0}),e.labelVantagemTotal=R(e.user.vantagens),e.totalprecoficha+=R(e.user.vantagens),p(100))},e.addDesvantagem=function(t){e.user.desvantagens=e.user.desvantagens||[];var a=e.user.desvantagens.search({key:"nome",value:t.nome});a||(e.user.desvantagens.unshift({nome:t.nome,custo:t.custo,plus:0}),e.labelDesVantagemTotal=R(e.user.desvantagens),e.totalprecoficha+=R(e.user.desvantagens),p(100))},e.removeVantagem=function(t){e.user.vantagens.remove({key:"nome",value:t.nome}),e.labelVantagemTotal=R(e.user.vantagens),e.totalprecoficha+=R(e.user.vantagens),p(100)},e.removeDesvantagem=function(t){e.user.desvantagens.remove({key:"nome",value:t.nome}),e.labelDesVantagemTotal=R(e.user.desvantagens),e.totalprecoficha+=R(e.user.desvantagens),p(100)},e.addPericia=function(t){e.user.pericias=e.user.pericias||[];var a=e.user.pericias.search({key:"nome",value:t.nome}),n=0;a||(e.user.pericias.unshift({nome:t.nome,nh:t.nh,custo:t.custo,plus:0}),"FACIL"==t.custo&&(n+=1),"MEDIO"==t.custo&&(n+=2),"DIFICIL"==t.custo&&(n+=4),"MUITO DIFICIL"==t.custo&&(n+=8),e.somacustopericias+=n,e.totalprecoficha+=n,p(100))},e.removePericia=function(t){e.user.pericias.remove({key:"nome",value:t.nome});var a=0;"FACIL"==t.custo&&(a+=-1),"MEDIO"==t.custo&&(a+=-2),"DIFICIL"==t.custo&&(a+=-4),"MUITO DIFICIL"==t.custo&&(a+=-8),e.somacustopericias+=a,e.totalprecoficha+=a,p(100)},e.clearForm=function(){e.user=i.getUser(),p(100)},e.salvar=function(){if(e.user){if(!e.user.nome||void 0==e.user.nome||""==e.user.nome)return p(100),void I("Escolha o nome do personagem.");if(!e.imgurl||void 0==e.imgurl)return p(100),void I("Escolha a imagem do personagem.");if(e.config.simetria){var t=parseInt(R(e.user.vantagens)),a=parseInt(R(e.user.desvantagens));if(a*=-1,t!=a)return void I("A configuração atual exige simetria das vantagens com as desvantagens.")}c.show({template:"Aguarde..."}),e.users=e.users||[],e.users.unshift(e.user),e.user.img=e.imgurl,e.user.atributos.von=e.user.atributos.dx,e.user.atributos.pf=e.user.atributos.ht,e.user.atributos.per=e.user.atributos.iq,e.user.atributos.pv=e.user.atributos.st,e.user.__atributos.st=e.user.atributos.st,e.user.__atributos.dx=e.user.atributos.dx,e.user.__atributos.iq=e.user.atributos.iq,e.user.__atributos.ht=e.user.atributos.ht,e.user.__atributos.von=e.user.atributos.dx,e.user.__atributos.pf=e.user.atributos.ht,e.user.__atributos.per=e.user.atributos.iq,e.user.__atributos.pv=e.user.atributos.st;var n=i.returnUserToSave(e.user);s.Sql.executeQuery(n),c.hide(),h(!1),e.novo.hide(function(){e.config.firsRun=!1,p(100)})}else r.alert({title:"Informação",template:"Campo nome obrigatório."})},e.editarRegistro=function(){e.user.img=e.imgurl;var t=i.returnUserToSave(e.user);s.Sql.executeQueryUpdate(t,e.user.id),h(!1),e.novo.hide(function(){p(100)})},e.excluir=function(){p(100);var t=r.confirm({title:"Exclusão de personagem",template:"Quer mesmo excluir este personagem?"});t.then(function(t){t&&(s.Sql.executeQueryExcluir(e.user.id),i.returnUsers().then(function(t){e.users=t,e.$digest(),c.hide(),e.novo.hide()},function(t){c.hide(),console.log(t),e.users=[],e.novo.hide()}))})},e.limpar=function(){e.user=i.getUser(),e.somacustopericias=0,e.labelVantagemTotal=0,e.labelDesVantagemTotal=0,e.atributoscustonovaficha=0,e.totalprecoficha=0,p(100)},e.pic=function(){c.show({template:"Aguarde..."});var t=0;e.config&&(t=e.config.camera_galeria?1:0),navigator.camera.getPicture(function(t){var a=document.createElement("img"),n="data:image/jpeg;base64,"+t,o=C.screenResolution.getIdealw(),i=C.screenResolution.getIdealh();a.src=n,e.imgurl=n,a.onload=function(){var e=document.getElementById("myCanvas").getContext("2d");e.drawImage(this,0,0,o,i),c.hide()}},function(e){console.log(e),c.hide()},{quality:e.config.quality,encodingType:Camera.EncodingType.JPEG,destinationType:Camera.DestinationType.DATA_URL,sourceType:t,correctOrientation:!1,allowEdit:!1})},o.$on("eventoEditar",function(t,a){c.show({template:"Carregando Personagem..."}),e.totalprecoficha=0;var n=document.getElementById("myCanvas");n&&n.focus(),e.editando=!0,m.toggleLeft(),l.scrollTop(),e.novo.show(),e.user=a;var o=document.createElement("img"),i=a.img;o.src=i,c.hide(),e.imgurl=i,o.onload=function(){var e=document.getElementById("myCanvas").getContext("2d"),t=C.screenResolution.getIdealw(),a=C.screenResolution.getIdealh();e.drawImage(this,0,0,t,a),this.src=""}}),e.updateConfig=function(t){e.lblCamQuality=u.Util.getLabelQualityFoto(e.config.quality),u.SetConfig(JSON.stringify(t)),p(100)},e.resetDados=function(t){p(100);var a=r.confirm({title:"Reset de dados",template:"Todos os personagens e pericias/vantagens/desvantagens serão apagados, a app ficará como da 1ª vez que instalou, deseja continuar?"});a.then(function(t){if(t){try{s.Sql.resetGeral().then(function(e){q(),h(!1);var t=document.getElementById("viewkey");t&&(t.style.display="none")})}catch(e){console.log(e)}e.configuracoes.hide()}else e.config.reset=t})},e.fill=function(t){e.addPericia(t)},e.criarPericias=function(t){var a=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});a.transaction(function(n){c.show({template:"Atualizando..."});try{a.executeSql("INSERT INTO tbpericias(data) VALUES (?)",[JSON.stringify(t)],function(a){t.id=a.insertId,e.listapericias.unshift(t),c.hide(function(){p(100)})})}catch(e){c.hide(),console.log(e)}})},e.removerPericia=function(t){p(100),event.stopPropagation();var a=r.confirm({title:"Remover Pericia?",template:"Deseja realmente remover esta pericia?"});a.then(function(a){if(a){var n=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});n.transaction(function(a){a.executeSql("delete from tbpericias where id = ?",[t.id]),e.listapericias.remove({key:"nome",value:t.nome}),p(100),e.$digest()})}})},e.editandoPericia=function(t){e.periciaeditando=t,e.editandopericia=!0},e.cancelarEditandoPericia=function(){e.editandopericia=!1},e.atualizarPericia=function(){e.cancelarEditandoPericia();var t=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});t.transaction(function(t){t.executeSql("update tbpericias set data=? where id=?",[JSON.stringify(e.periciaeditando),e.periciaeditando.id])},function(e){console.log("Transaction ERROR: "+error.message)},function(){console.log("Update na tbpericias OK")})},e.criarVantagem=function(t){var a=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});a.transaction(function(n){c.show({template:"Atualizando..."});try{a.executeSql("INSERT INTO tbvantagens(data) VALUES (?)",[JSON.stringify(t)],function(a){t.id=a.insertId,t.tipo="vantagem",e.listavantagens.unshift(t),p(100),c.hide()})}catch(e){c.hide(),console.log(e)}})},e.editandoVantagem=function(t){t.custo=parseInt(t.custo),e.vantagemnovaeditando=t,e.editandovantagem=!0},e.atualizarVantagem=function(){e.cancelarEditandoVantagem();var t=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});t.transaction(function(t){t.executeSql("update tbvantagens set data=? where id=?",[JSON.stringify(e.vantagemnovaeditando),e.vantagemnovaeditando.id])},function(e){console.log("Transaction ERROR: "+error.message)},function(){console.log("Update na vantagemnovaeditando OK")})},e.removerVantagem=function(t){p(100),event.stopPropagation();var a=r.confirm({title:"Remover Vantagem?",template:"Deseja realmente remover esta vantagem?"});a.then(function(a){if(a){var n=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});n.transaction(function(a){a.executeSql("delete from tbvantagens where id = ?",[t.id]),e.listavantagens.remove({key:"nome",value:t.nome}),p(100),e.$digest()})}})},e.cancelarEditandoVantagem=function(){e.editandovantagem=!1},e.editandoDesvantagem=function(t){t.custo=parseInt(t.custo),e.desvantagemnovaeditando=t,e.editandodesvantagem=!0},e.cancelarEditandodesVantagem=function(){e.editandodesvantagem=!1},e.atualizardesVantagem=function(){e.cancelarEditandodesVantagem();var t=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});t.transaction(function(t){t.executeSql("update tbdesvantagens set data=? where id=?",[JSON.stringify(e.desvantagemnovaeditando),e.desvantagemnovaeditando.id])},function(e){console.log("Transaction ERROR: "+error.message)},function(){console.log("Update na vantagemnovaeditando OK")})},e.criardesVantagem=function(t){var a=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});a.transaction(function(n){c.show({template:"Atualizando..."});try{a.executeSql("INSERT INTO tbdesvantagens(data) VALUES (?)",[JSON.stringify(t)],function(a){t.id=a.insertId,t.tipo="desvantagem",e.listadesvantagens.unshift(t),p(100),c.hide()})}catch(e){c.hide(),console.log(e)}})},e.removerDesvantagem=function(t){p(100);var a=r.confirm({title:"Remover Desvantagem?",template:"Deseja realmente remover esta desvantagem?"});a.then(function(a){if(a){var n=window.sqlitePlugin.openDatabase({name:"gurps.db",location:"default"});n.transaction(function(a){a.executeSql("delete from tbdesvantagens where id = ?",[t.id]),e.listadesvantagens.remove({key:"nome",value:t.nome}),p(100),e.$digest()})}})},e.contato=function(){window.plugins.socialsharing.shareViaEmail("","Gmobi",["contato@aldocosta.com.br"],null,null,null,function(){},function(){}),p(100)},e.rolarDados=function(t){e.d6Result=v.DiceRoll.D6.rollD6(t),p(100)},e.shareResult=function(){window.plugins.socialsharing.shareViaWhatsApp("Gmobi: Rolagem: "+e.d6Result,null,null,function(){console.log("share ok")},function(e){alert(e)})},e.atributosCalc=function(){var t=0;e.user.atributos.st>0&&(t+=10*(e.user.atributos.st-10)),e.user.atributos.dx>0&&(t+=20*(e.user.atributos.dx-10)),e.user.atributos.iq>0&&(t+=20*(e.user.atributos.iq-10)),e.user.atributos.ht>0&&(t+=10*(e.user.atributos.ht-10)),e.atributoscustonovaficha=t,e.totalprecoficha=t},e.carregandoPericias=function(){c.show({template:"Carregando apenas perícias (+ rápido)..."}),b(!1).then(function(t){p(100),c.hide(),e.listavantagens=[],e.listadesvantagens=[]},function(){c.hide()})},e.carregandoVantagens=function(){c.show({template:"Carregando apenas vantagens (+ rápido)..."}),w().then(function(){p(100),e.listadesvantagens=[],e.listapericias=[],c.hide()}).catch(function(){c.hide()})},e.carregandoDesvantagens=function(){c.show({template:"Carregando apenas desvantagens (+ rápido)..."}),y().then(function(){p(100),e.listapericias=[],e.listavantagens=[],c.hide()}).catch(function(e){c.hide()})}}]);